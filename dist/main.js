/* Twitch Filtered Chat Loader */"use strict";/* Module names (also used as directory names) */var MOD_TFC="twitch-filtered-chat",MOD_TWAPI="twitch-api",URI=""+window.location,IS_TESLA=!!navigator.userAgent.match(/\bTesla\b/),USE_DIST=IS_TESLA||!!window.location.search.match(/\busedist\b/),BASE_URI=URI.substr(0,URI.indexOf("twitch-filtered-chat")).replace(/\/$/,""),SELF_URI=URI.replace(/\/index.html(\?.*)?$/,""),GIT_URL="https://kaedenn.github.io/twitch-filtered-chat/index.html",CUR_URL=function(){var a=window.location;return a.protocol+"//"+a.hostname+a.pathname}();/* Obtain information based on window.location and navigator.userAgent *//* Paths to modules */function addDistPath(a){return a+(USE_DIST?"/dist":"")}var PATH_TFC=addDistPath(SELF_URI),PATH_TWAPI_EXTERNAL=addDistPath(BASE_URI+"/"+"twitch-api"),PATH_TWAPI_INTERNAL=addDistPath(SELF_URI+"/"+"twitch-api"),PATH_TWAPIS=function(){var a=[PATH_TWAPI_EXTERNAL,PATH_TWAPI_INTERNAL],b=[PATH_TWAPI_INTERNAL,PATH_TWAPI_EXTERNAL];if(-1<window.location.search.indexOf("twapi=")){if(-1<window.location.search.indexOf("twapi=e"))return a;if(-1<window.location.search.indexOf("twapi=i"))return b}return"file:"===window.location.protocol?a:b}(),ASSETS={};/* Determine the order of the twapi modules *//* Asset storage object *//* Layout {{{0 *//* Obtain the layout to use */function GetLayout(){/* exported GetLayout */return ParseLayout(Util.ParseQueryString().layout||"double:chat")}/* Parse layout= query string value */function ParseLayout(a){/* exported ParseLayout */var b={Cols:null,Chat:!0,Slim:!1};if(-1<a.indexOf(":")){var c=a.substr(0,a.indexOf(":")),d=a.substr(a.indexOf(":")+1);"single"===c?b.Cols="single":"double"===c?b.Cols="double":(console.warn("Unknown layout \""+c+"\"; defaulting to double"),b.Cols="double"),"nochat"===d?b.Chat=!1:"slim"===d?(b.Slim=!0,b.Chat=!1):"chat"!==d&&console.warn("Unknown layout option",d)}else"single"===a?b.Cols="single":"double"===a?b.Cols="double":"tesla"===a?(b.Cols="single",b.Chat=!1,b.Slim=!0,b.Tesla=!0):console.error("Failed to parse layout",a);return b}/* Generate layout= query string value */function FormatLayout(a){/* exported FormatLayout */if(a.Tesla)return"tesla";var b="",c="";return"single"===a.Cols?b="single":"double"===a.Cols&&(b="double"),c=a.Slim?"slim":a.Chat?"chat":"nochat",b+":"+c}/* End of layout functions 0}}} *//* Add an asset to be loaded; returns a Promise */function AddAsset(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,e=c||function(){return null},f=d||function(){return null},g=(b?b+"/":"")+a;/* Callback defaults *//* Determine the final path to the asset *//* Prevent double-loading */if(a.startsWith("//")&&(g=window.location.protocol+a),console.debug(a+" @ "+b+" -> "+g),ASSETS[g])throw new Error("Duplicate asset "+g+": "+JSON.stringify(ASSETS[g]));/* Construct and load the asset */var h=ASSETS[g]={};return new Promise(function(c,d){console.info("About to load asset",g),h.file=a,h.src=g,h.tree=b,h.loaded=!1,h.error=!1,h.script=document.createElement("script"),h.script.setAttribute("type","text/javascript"),h.script.setAttribute("src",h.src),h.script.onload=function(){console.log(h.src+" loaded"),h.loaded=!0,e(h),c(h)},h.script.onerror=function(a){console.error("Failed loading",h,a),h.error=!0,f(h,a),d(a)},document.head.appendChild(h.script)})}/* Called by body.onload */function Main(){/* Extend jQuery with some useful methods *//* Load the TWAPI assets, trying each path until success */(function(a){/* Check or uncheck a checkbox (e.check(), e.check(false)) *//* Uncheck a checkbox */a.fn.check=function(){var a=!(0<arguments.length)||!(0>=arguments.length?!void 0:!arguments[0]);this.each(function(b,c){c.checked=a,c.setAttribute("checked","checked"),c.dispatchEvent(new Event("change"))})},a.fn.uncheck=function(){this.each(function(a,b){b.checked=!1,b.removeAttribute("checked"),b.dispatchEvent(new Event("change"))})}})(jQuery),Promise.all([AddAsset("utility.js",PATH_TWAPIS[0],null,null),AddAsset("client.js",PATH_TWAPIS[0],null,null)]).catch(function(){return Promise.all([AddAsset("utility.js",PATH_TWAPIS[1],null,null),AddAsset("client.js",PATH_TWAPIS[1],null,null)])})/* Then load the config script */.then(function(){return AddAsset("config.js",PATH_TFC,null,null)})/* Then load TFC */.then(function(){return Promise.all([AddAsset("htmlgen.js",PATH_TFC,null,null),AddAsset("commands.js",PATH_TFC,null,null),AddAsset("filtered-chat.js",PATH_TFC,null,null),AddAsset("plugins/plugins.js",PATH_TFC,null,null)])})/* Then load the fanfare scripts */.then(function(){return Promise.all([AddAsset("fanfare/particle.js",PATH_TFC),AddAsset("fanfare/effect.js",PATH_TFC),AddAsset("fanfare/fanfare.js",PATH_TFC)])})/* And finally call main */.then(/* exported Main *//* Populate templates and load the client */function(){Util.LogOnly("Assets loaded; initializing page..."),$("#wrapper #wrapper-loading").remove();/* Obtain a layout to use */var a=GetLayout(),b=$("<textarea id=\"txtChat\"></textarea>").attr("placeholder","Send a message"),c=$("<div id=\"chat\"></div>").append(b),d=$(".column"),e=$(".module"),f=[$("#column1"),$("#column2")],g=f[0],h=f[1],i=[$("#module1"),$("#module2")],j=i[0],k=i[1];/* Create the chat input elements *//* Apply default settings and formatting *//* Default: all checkboxes are checked *//* Add the chat box */if(e.find(".header .settings input[type=\"checkbox\"]").attr("checked","checked"),e.find(".header label.name").val("Chat"),e.find(".header input.name").attr("value","Chat"),"single"===a.Cols?(g.removeClass("left").addClass("full"),j.removeClass("left").addClass("full"),g.show(),h.remove()):d.show(),a.Chat){var l="single"===a.Cols?j:k;l.removeClass("no-chat"),l.addClass("has-chat"),l.append(c)}/* Shrink the content for the Tesla */a.Tesla&&$(".module .content").css("height","calc(100% - 2em)"),a.Slim&&($("body").addClass("tfc-slim"),$(".module").addClass("slim"),$(".content").addClass("slim"),$(".header").hide(),$("#btnSettings").hide()),InitChatCommands(),Util.LogOnly("Waiting for document to finish rendering..."),requestAnimationFrame(function(){/* Focus on the chat texarea */var a=document.getElementById("txtChat");a&&a.focus&&a.focus(),Util.LogOnly("Document rendered; setting up TFC...");try{doLoadClient()}catch(a){if(console.error(a),"ReferenceError"===a.name){var b=a.message||"";b.match(/\bdoLoadClient\b.*(?:not |un)defined\b/)&&alert("FATAL: filtered-chat.js failed to load")}else{var c="doLoadClient error: "+a.toString();a.stack&&(c+=";\nstack: "+a.stack.toString()),alert(c)}throw a}})}).catch(function(a){console.error(a);var b="TWAPI/TFC Failure ",c=a.target||a.srcElement||a.originalTarget||a;b+=c?c.attributes&&c.attributes.src&&c.attributes.src.value?"while loading "+c.attributes.src.value:c.outerHTML?"while loading "+c.outerHTML:c.nodeValue?"while loading "+c.nodeValue:"while loading "+c:"while loading unknown target",b+=":\n"+a+(a.stack?";\nstack: "+a.stack:""),console.error(b,a),alert(b)})}/* eslintrc config: *//* exported MOD_TFC MOD_TWAPI USE_DIST URI BASE_URI SELF_URI GIT_URL CUR_URL *//* exported PATH_TFC *//* globals InitChatCommands doLoadClient *//* vim: set ts=2 sts=2 sw=2 et: */