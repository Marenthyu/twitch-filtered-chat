/* Twitch Filtered Chat Main Module */"use strict";/* FIXME:
 * Fanfares ignore cbAnimCheers
 *//* AUTHENTICATION
 *
 * https://id.twitch.tv/oauth2/authorize
 *  ?response_type=token
 *  &client_id=<client-id>
 *  &redirect_uri=https://kaedenn.github.io/twitch-filtered-chat/index.html
 *  &scope=<scopes>
 *  &state=<secure random value>
 *
 * Optional:
 *  force_verify: boolean (default false)
 *  Enable to force verification every time
 *
 * Scopes: chat:edit+chat:read+channel:moderate
 *  bits:read perhaps?
 *
 * Redirect will be to
 *  https://kaedenn.github.io/twitch-filtered-chat/index.html
 *    #access_token=<OAuth token>
 *    &scope=<scopes>
 *    &state=<state>
 *    &token_type=bearer
 *  Note that this uses the hash fragment: window.location.hash
 *
 * Concerns:
 *  1) How do I verify &state? Should it be a secure hash of some
 *    client-supplied value? Use localStorage?
 *  2) How should the query string config values be replaced? Store them into
 *    localStorage, redirect to oauth2/authorize, then confirm values?
 *
 * Idea:
 *  1. Navigate to tfc/index.html?<options>
 *  2. Generate state value
 *  3. Store options with state into localStorage temporarily
 *  4. Redirect user to oauth2/authorize
 *  5. Obtain options and state from localStorage (and purge)
 *  6. If state matches, use token, otherwise discard with error
 *//* TODO (in approximate decreasing priority):
 * Implement selClearStyle for all(?) ways to clear chat
 *   !tfc nuke
 *   CLEARCHAT
 *   CLEARMSG
 * Add to content to both of the settings help and builder links
 *   Change AssetPaths.BUILDER_WINDOW to use the new builder
 * Authenticate using Twitch's implicit OAuth flow?
 *   Ensure this doesn't preclude query string configuration, or if it does,
 *   somehow work around it
 * Create a README.md file for the plugins directory. Include documentation on:
 *   Commands
 *   Filtering
 *   Plugin creation and loading
 *   Plugin configuration (?plugincfg)
 * Auto-complete command arguments
 * Remove F1 hotkey binding
 *//* IDEAS:
 * Add layout selection box to #settings (reloads page on change)?
 * Allow for a configurable number of columns? Configurable layout?
 * Add re-include (post-exclude) filtering options for Mods, Bits, Subs, etc?
 *//* Utility functions {{{0 *//* Call func when the input element is changed */var _slicedToArray=function(){function e(e,t){var a=[],n=!0,r=!1,d=void 0;try{for(var i,l=e[Symbol.iterator]();!(n=(i=l.next()).done)&&(a.push(i.value),!(t&&a.length===t));n=!0);}catch(e){r=!0,d=e}finally{try{!n&&l["return"]&&l["return"]()}finally{if(r)throw d}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var a,n=0;n<t.length;n++)a=t[n],a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function onChange(t,a){/* Default function wrapper */function n(e){return a.bind(this)(e)}var r=!0,d=!1,i=void 0;try{for(var l,o=$(t)[Symbol.iterator]();!(r=(l=o.next()).done);r=!0){var s=l.value,e=$(s);if(e.is("input")){var c=e.attr("type");"text"===c?(e.keyup(function(e){if("Enter"===e.key)return a.bind(this)(e)}),e.blur(n)):e.change(n)}else/* Other elements: change */e.change(n)}}catch(e){d=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(d)throw i}}}/* End utility functions 0}}} *//* Document writing functions {{{0 */var Content=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"add",/* exported Content *//* Add text: escapes */value:function a(e){t.addHTML($("<span class=\"message\"></span>").text(e))}/* Add HTML: does not escape */},{key:"addHTML",value:function d(e){var t=Math.pow,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=a?$(a):$(".module .content"),r=$("<div class=\"line line-wrapper\"></div>");"string"==typeof e?r.html(e):e instanceof Node?r.append($(e)):r.append(e),n.append(r),n.attr("data-no-scroll")||n.scrollTop(t(2,31)-1)}/* Add "pre" content: does not escape */},{key:"addPre",value:function a(e){t.addHTML($("<div class=\"pre\"></div>").html(e))}/* Add "pre" text: escapes */},{key:"addPreText",value:function a(e){t.addHTML($("<div class=\"pre\"></div>").text(e))}/* Add info content: does not escape */},{key:"addInfo",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"info\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add info text: escapes */},{key:"addInfoText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"info\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add notice (warning) content: does not escape */},{key:"addNotice",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"notice\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add notice (warning) text: escapes */},{key:"addNoticeText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"notice\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add error content: does not escape */},{key:"addError",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"error\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add error text: escapes */},{key:"addErrorText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"error\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add help content: does not escape */},{key:"addHelp",value:function a(e){t.addPre($("<div class=\"help\"></div>").html(e))}/* Add help text: escapes */},{key:"addHelpText",value:function a(e){t.addPre($("<div class=\"help\"></div>").text(e))}/* Add help line pair: escapes when escape=true (default false) */},{key:"addHelpLine",value:function r(e,a){var n=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2];t.addHelp(ChatCommands.helpLine(e,a,n))}/* Add a help line with indent; escapes when escape=true (default false) */},{key:"addHelpTextLine",value:function n(e){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];t.addHelp(ChatCommands.helpTextLine(e,a))}}]),t}();/* End document writing functions 0}}} *//* Begin configuration section {{{0 *//* Merge the query string into the config object given and return removals */function parseQueryString(e){var t=Math.clamp,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={},r=[],d=a||window.location.search;/* Figure out what was passed *//* Generated configuration *//* List of keys to remove from window.location */"string"==typeof d?n=Util.ParseQueryString(d):"object"===("undefined"==typeof d?"undefined":_typeof(d))?n=d:Util.Error("Refusing to parse strange query string object",d);var i=!0,l=!1,o=void 0;try{for(var s,c=Object.entries(n)[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,g=_slicedToArray(u,2),p=g[0],h=g[1],f=p,m=h;/* config key *//* config val */if("clientid"===p)f="ClientID",e.__clientid_override=!0,r.push(p);else if("user"===p||"name"===p||"nick"===p)f="Name";else if("pass"===p||"oauth"===p)f="Pass",r.push(p);else if("channel"===p||"channels"===p)f="Channels",m=h.split(",").map(function(e){return Twitch.FormatChannel(e)});else if("debug"===p)f="Debug",m="boolean"==typeof h?h:"number"==typeof h?t(h,Util.LEVEL_MIN,Util.LEVEL_MAX):"debug"===h?Util.LEVEL_DEBUG:"trace"===h?Util.LEVEL_TRACE:!!h;else if("noassets"===p)f="NoAssets",m=!!h;else if("noffz"===p)f="NoFFZ",m=!!h;else if("nobttv"===p)f="NoBTTV",m=!!h;else if("hmax"===p)f="HistorySize","inf"===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid hmax value "+h+"; defaulting"),m=TwitchClient.DEFAULT_HISTORY_SIZE);else if(p.match(/^module[\d]*?$/))f="module"===p?"module1":p,m=parseModuleConfig(h);else if("trans"===p||"transparent"===p)f="Transparent",m=1;else if("layout"===p)f="Layout",m=ParseLayout(h);else if("norec"===p)f="NoAutoReconnect",m=!0;else if("size"===p)f="Size",m=h+"pt";else if("plugins"===p)f="Plugins",m=!!h;else if("disable"===p)f="DisableEffects",m=h.split(",");else if("enable"===p)f="EnableEffects",m=h.split(",");else if("max"===p)f="MaxMessages","inf"===h||-1===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid max value "+h+"; defaulting"),m=TwitchClient.DEFAULT_MAX_MESSAGES);else if("font"===p)f="Font",m=""+h;else if("scroll"===p)f="Scroll",m=!!h;else if("clips"===p)f="ShowClips",m=!!h;else if("plugincfg"===p){f="PluginConfig";try{m=JSON.parse(h)}catch(t){Util.Error(t),f=m=null}}else if("scheme"===p)f="ColorScheme","light"===h?m="light":"dark"===h?m="dark":(Util.WarnOnly("Invalid scheme value "+h+", defaulting to dark"),m="dark");else if("force"===p||"antics"===p)f="EnableForce",m=!!h;else if("fanfare"===p){f="Fanfare",m={enable:!1};try{var b=JSON.parse(h);"number"==typeof b?m.enable=0!==b:"boolean"==typeof b?m.enable=b:"object"===("undefined"==typeof b?"undefined":_typeof(b))?(m=b,m.enable=!0):(Util.Error("Don't know how to parse Fanfare value",b),f=m=null)}catch(t){Util.Error("Failed parsing Fanfare config; disabling",t,h),f=m=null}}else"highlight"===p&&(f="Highlight",m=(""+h).split(",").map(function(e){return Util.StringToRegExp(e,"g")}));/* Skip items with a falsy key */f&&(e[f]=m)}}catch(e){l=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(l)throw o}}return r}/* Obtain configuration key */function getConfigKey(){var e=CFG_KEY,t=Util.ParseQueryString(),a=t.config_key||t.key||t["config-key"];return a&&(e=e+"-"+a.replace(/[^a-z0-9_-]/g,"")),e}/* Obtain configuration */function getConfigObject(){var t=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],a=null,n=null,r=Util.ParseQueryString();/* 1) Obtain configuration values
   *  a) from localStorage
   *  b) from query string (overrides (a))
   *  c) from settings elements (overrides (b))
   *  d) from liveStorage (module settings only, overrides (c))
   * 2) Store module configuration in each modules' settings window
   * 3) Remove sensitive values from the query string, if present
   *//* Query String object, parsed *//* Obtain configuration from local storage */if(r.nols)Util.DisableLocalStorage(),n={};else{a=getConfigKey(),Util.SetWebStorageKey(a),a!==CFG_KEY&&Util.LogOnlyOnce("Using custom config key \""+Util.GetWebStorageKey()+"\""),n=Util.GetWebStorage()||{},n.key=a;/* Purge obsolete configuration items */var d=["AutoReconnect","NoForce"],i=!1,l=!0,o=!1,s=void 0;try{for(var c,u,g=d[Symbol.iterator]();!(l=(c=g.next()).done);l=!0)u=c.value,n.hasOwnProperty(u)&&(i=!0,delete n[u])}catch(e){o=!0,s=e}finally{try{!l&&g.return&&g.return()}finally{if(o)throw s}}i&&Util.SetWebStorage(n)}/* Certain unwanted items may be preserved in localStorage */var p=["NoAssets","Debug","NoAutoReconnect","Layout","Transparent","Plugins","EnableEffects","DisableEffects","PluginConfig","ColorScheme","nols","EnableForce"],h=!0,f=!1,m=void 0;try{for(var b,v,S=p[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)v=b.value,n.hasOwnProperty(v)&&delete n[v];/* Parse the query string, storing items to remove */}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}var y=parseQueryString(n,r);/* Ensure config.Channels is present for #settings configuration below */Util.IsArray(n.Channels)||(n.Channels=[]);/* Obtain global settings config */var x=$("input#txtChannel"),C=$("input#txtNick"),k=$("input#txtPass");if(x.val()){var L=!0,T=!1,E=void 0;try{for(var w,H=x.val().split(",")[Symbol.iterator]();!(L=(w=H.next()).done);L=!0){var I=w.value,P=Twitch.FormatChannel(I.toLowerCase());-1===n.Channels.indexOf(P)&&n.Channels.push(P)}}catch(e){T=!0,E=e}finally{try{!L&&H.return&&H.return()}finally{if(T)throw E}}}/* See if there's any sensitive information we need to remove */if(C.val()&&C.val()!==Strings.NAME_AUTOGEN&&(n.Name=C.val()),t&&k.val()&&k.val()!==Strings.PASS_CACHED&&(n.Pass=k.val()),n.hasOwnProperty("Scroll")||(n.Scroll=$("#cbScroll").is(":checked")),n.hasOwnProperty("ShowClips")||(n.ShowClips=$("#cbClips").is(":checked")),n.hasOwnProperty("EnableForce")||(n.EnableForce=$("#cbForce").is(":checked")),$(".module").each(function(){var e=$(this).attr("id"),t=function(e){return Util.IsArray(e)?e:[]};/* Populate module configuration from liveStorage (if present) */if(n[e]||(n[e]=getModuleSettings($(this))),window.liveStorage&&window.liveStorage[e]){var a=!0,r=!1,d=void 0;try{for(var i,l=Object.entries(window.liveStorage[e])[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var o=i.value,s=_slicedToArray(o,2),c=s[0],u=s[1];n[e][c]=u}}catch(e){r=!0,d=e}finally{try{!a&&l.return&&l.return()}finally{if(r)throw d}}}/* Ensure all the settings have the proper types */n[e].Pleb=!!n[e].Pleb,n[e].Sub=!!n[e].Sub,n[e].VIP=!!n[e].VIP,n[e].Mod=!!n[e].Mod,n[e].Event=!!n[e].Event,n[e].Bits=!!n[e].Bits,n[e].Me=!!n[e].Me,n[e].IncludeKeyword=t(n[e].IncludeKeyword),n[e].IncludeUser=t(n[e].IncludeUser),n[e].ExcludeUser=t(n[e].ExcludeUser),n[e].ExcludeStartsWith=t(n[e].ExcludeStartsWith),n[e].FromChannel=t(n[e].FromChannel)}),0<y.length){Util.SetWebStorage(n);/* Obtain the current query string */var M=Util.ParseQueryString(window.location.search.substr(1)),N=!1;M.base64&&0<M.base64.length&&(N=!0,M=Util.ParseQueryString(atob(M.base64)));/* Remove the sensitive items */var A=!0,D=!1,F=void 0;try{for(var _,O,G=y[Symbol.iterator]();!(A=(_=G.next()).done);A=!0)O=_.value,delete M[O];/* Create and apply a new query string */}catch(e){D=!0,F=e}finally{try{!A&&G.return&&G.return()}finally{if(D)throw F}}var z=Util.FormatQueryString(M);N&&(z="?base64="+encodeURIComponent(btoa(z))),window.location.search=z}/* Merge in top-level liveStorage items */if(window.liveStorage){var U=!0,R=!1,W=void 0;try{for(var j,V,B=Object.keys(window.liveStorage)[Symbol.iterator]();!(U=(j=B.next()).done);U=!0)V=j.value,V.match(/^module[0-9]*$/)||n[V]===window.liveStorage[V]||(n[V]=window.liveStorage[V])}catch(e){R=!0,W=e}finally{try{!U&&B.return&&B.return()}finally{if(R)throw W}}}/* Finally, ensure certain defaults *//* Default name is no name */return"string"!=typeof n.Name&&(n.Name=""),n.hasOwnProperty("Plugins")||(n.Plugins=!1),n.hasOwnProperty("Debug")||(n.Debug=!1),n.hasOwnProperty("Channels")||(n.Channels=[]),n.hasOwnProperty("Layout")||(n.Layout=GetLayout()),n.hasOwnProperty("MaxMessages")||(n.MaxMessages=TwitchClient.DEFAULT_MAX_MESSAGES),n.hasOwnProperty("HistorySize")||(n.HistorySize=TwitchClient.DEFAULT_HISTORY_SIZE),t?!n.ClientID&&(n.ClientID=[19,86,67,115,22,38,198,3,55,118,67,35,150,230,71,134,83,3,119,166,86,39,38,167,135,134,147,214,38,55].map(function(e){return Util.ASCII[16*(15&e)+(240&e)/16]}).join("")):(n.ClientID=null,delete n.ClientID,delete n.Pass),n}/* Obtain singular configuration */function getConfigValue(e){return getConfigObject()[e]}/* Store configuration */function mergeConfigObject(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,t=e||{},a=getConfigObject(!0);if(Util.IsArray(t)){var n=!0,r=!1,d=void 0;try{for(var i,l=t[Symbol.iterator]();!(n=(i=l.next()).done);n=!0){var o=i.value,s=_slicedToArray(o,2),c=s[0],u=s[1];a[c]=u}}catch(e){r=!0,d=e}finally{try{!n&&l.return&&l.return()}finally{if(r)throw d}}}else{var g=!0,p=!1,h=void 0;try{for(var f,m=Object.entries(t)[Symbol.iterator]();!(g=(f=m.next()).done);g=!0){var b=f.value,v=_slicedToArray(b,2),S=v[0],y=v[1];a[S]=y}}catch(e){p=!0,h=e}finally{try{!g&&m.return&&m.return()}finally{if(p)throw h}}}Util.SetWebStorage(a),window.liveStorage=a}/* Generate a URL from the given config object */function genConfigURL(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,a=t||{},n=a.git?GIT_URL:CUR_URL,r=[],d=function(e,t){return r.push(e+"="+encodeURIComponent(t))};a.key&&d("key",a.key),0<e.Debug&&d("debug",e.Debug),e.__clientid_override&&d("clientid",e.ClientID),e.Channels&&d("channels",e.Channels.join(",")),e.NoAssets&&d("noassets",e.NoAssets),e.NoFFZ&&d("noffz",e.NoFFZ),e.NoBTTV&&d("nobttv",e.NoBTTV),e.HistorySize&&d("hmax",e.HistorySize);var i=!0,l=!1,o=void 0;try{for(var s,c,u=Object.keys(getModules())[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)c=s.value,e[c]&&d(c,formatModuleConfig(e[c]))}catch(e){l=!0,o=e}finally{try{!i&&u.return&&u.return()}finally{if(l)throw o}}e.Layout&&d("layout",FormatLayout(e.Layout)),e.Transparent&&d("trans","1"),e.NoAutoReconnect&&d("norec","1");var g=Util.CSS.GetProperty("--body-font-size"),p=Util.CSS.GetProperty("--body-font-size-default");return g!==p&&d("size",g.replace(/[^0-9]/g,"")),e.Plugins&&d("plugins","1"),e.MaxMessages!==TwitchClient.DEFAULT_MAX_MESSAGES&&d("max",""+e.MaxMessages),e.Font&&d("font",e.Font),e.Scroll&&d("scroll","1"),e.ShowClips&&d("clips","1"),a.auth&&e.Name&&e.Pass&&(d("user",e.Name),d("pass",e.Pass)),e.DisableEffects&&d("disable",e.DisableEffects.join(",")),e.EnableEffects&&d("enable",e.EnableEffects.join(",")),e.PluginConfig&&d("plugincfg",JSON.stringify(e.PluginConfig)),"dark"===e.ColorScheme?d("scheme","dark"):"light"===e.ColorScheme&&d("scheme","light"),e.EnableForce&&d("force","1"),e.Fanfare&&d("fanfare",JSON.stringify(e.Fanfare)),e.Highlight&&d("highlight",e.Highlight.map(function(e){return""+e}).join(",")),a.tag?d("tag",a.tag):e.tag&&d("tag",e.tag),a.base64?n+"?base64="+encodeURIComponent(btoa(r.join("&"))):n+"?"+r.join("&")}/* Module configuration {{{1 *//* Enumerate the active modules */function getModules(){/* exported getModules */var e={},t=!0,a=!1,n=void 0;try{for(var r,d,i=$(".module")[Symbol.iterator]();!(t=(r=i.next()).done);t=!0)d=r.value,e[$(d).attr("id")]=d}catch(e){a=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(a)throw n}}return e}/* Apply configuration to the module's settings HTML */function setModuleSettings(e,t){function a(e,t){/* Add checkbox for the given values */var a=CSS.escape(e),r=n.find("li."+a),d=r.find("label").last().html()+" ",i=!0,l=!1,o=void 0;try{for(var s,c=t[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,g=CSS.escape(u);/* Add checkbox if value isn't already present */if(0===n.find("input."+a+"[value=\""+g+"\"]").length){var p=$("<input type=\"checkbox\" checked />").addClass(e).attr("value",u).click(updateModuleConfig),h=$("<label></label>").val(d).append(p);h.html(h.html()+d+u.escape());var f=$("<li></li>").append(h);r.before(f)}}}catch(e){l=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(l)throw o}}}var n=$(e);t.Name&&(n.find("label.name").html(t.Name),n.find("input.name").val(t.Name)),n.find("input.pleb").check(t.Pleb),n.find("input.sub").check(t.Sub),n.find("input.vip").check(t.VIP),n.find("input.mod").check(t.Mod),n.find("input.event").check(t.Event),n.find("input.bits").check(t.Bits),n.find("input.me").check(t.Me),a("include_user",t.IncludeUser||[]),a("include_keyword",t.IncludeKeyword||[]),a("exclude_user",t.ExcludeUser||[]),a("exclude_startswith",t.ExcludeStartsWith||[]),a("from_channel",t.FromChannel||[])}/* Obtain the settings from the module's settings HTML */function getModuleSettings(e){var t=$(e),a={Name:t.find("input.name").val(),Pleb:t.find("input.pleb").is(":checked"),Sub:t.find("input.sub").is(":checked"),VIP:t.find("input.vip").is(":checked"),Mod:t.find("input.mod").is(":checked"),Event:t.find("input.event").is(":checked"),Bits:t.find("input.bits").is(":checked"),Me:t.find("input.me").is(":checked"),IncludeUser:[],IncludeKeyword:[],ExcludeUser:[],ExcludeStartsWith:[],FromChannel:[]};return t.find("input.include_user:checked").each(function(){a.IncludeUser.push($(this).val())}),t.find("input.include_keyword:checked").each(function(){a.IncludeKeyword.push($(this).val())}),t.find("input.exclude_user:checked").each(function(){a.ExcludeUser.push($(this).val())}),t.find("input.exclude_startswith:checked").each(function(){a.ExcludeStartsWith.push($(this).val())}),t.find("input.from_channel:checked").each(function(){a.FromChannel.push($(this).val())}),a}/* Parse a module configuration object from a query string component */function parseModuleConfig(e){for(var t=function(e){return e.map(function(e){return decodeURIComponent(e)})},a=t(e.split(/,/g));7>a.length;)a.push("");/* Upgrade configuration from 6x to 7x */"111111"===a[1]&&(a[1]="1111111");var n=Util.DecodeFlags(a[1],7),r={};return r.Name=a[0],r.Pleb=n[0],r.Sub=n[1],r.VIP=n[2],r.Mod=n[3],r.Event=n[4],r.Bits=n[5],r.Me=n[6],r.IncludeKeyword=a[2]?t(a[2].split(/,/g)):[],r.IncludeUser=a[3]?t(a[3].split(/,/g)):[],r.ExcludeUser=a[4]?t(a[4].split(/,/g)):[],r.ExcludeStartsWith=a[5]?t(a[5].split(/,/g)):[],r.FromChannel=a[6]?t(a[6].split(/,/g)):[],r}/* Format the module configuration object into a query string component */function formatModuleConfig(e){var t=function(e){return e.map(function(e){return encodeURIComponent(e)})},a=[e.Pleb,e.Sub,e.VIP,e.Mod,e.Event,e.Bits,e.Me],n=[e.Name,Util.EncodeFlags(a,!1),t(e.IncludeKeyword).join(","),t(e.IncludeUser).join(","),t(e.ExcludeUser).join(","),t(e.ExcludeStartsWith).join(","),t(e.FromChannel).join(",")];return t(n).join(",")}/* Store the modules' settings in both localStorage and liveStorage */function updateModuleConfig(){var e={};$(".module").each(function(){var t=$(this).attr("id");e[t]=getModuleSettings($(this)),window.liveStorage||(window.liveStorage={}),window.liveStorage[t]=e[t]}),mergeConfigObject(e)}/* End module configuration 1}}} *//* Set the joined channels to the list given */function setChannels(e,t){var a=function(e){return Twitch.FormatChannel(Twitch.ParseChannel(e))},n=t.map(a),r=e.GetJoinedChannels().map(a),d=n.filter(function(e){return-1===r.indexOf(e)}),i=r.filter(function(e){return-1===n.indexOf(e)}),l=!0,o=!1,s=void 0;/* Join all the channels added */try{for(var c,u,g=d[Symbol.iterator]();!(l=(c=g.next()).done);l=!0)u=c.value,e.JoinChannel(u),Content.addNoticeText("Joining "+u);/* Leave all the channels removed */}catch(e){o=!0,s=e}finally{try{!l&&g.return&&g.return()}finally{if(o)throw s}}var p=!0,h=!1,f=void 0;try{for(var m,b,v=i[Symbol.iterator]();!(p=(m=v.next()).done);p=!0)b=m.value,e.LeaveChannel(b),Content.addNoticeText("Leaving "+b)}catch(e){h=!0,f=e}finally{try{!p&&v.return&&v.return()}finally{if(h)throw f}}}/* End configuration section 0}}} *//* Return whether or not the event should be filtered */function shouldFilter(e,t){var a=getModuleSettings(e);if(t instanceof TwitchChatEvent){var n=t.user||"",r=t.message?t.message.toLowerCase():"",d="pleb";/* NOTE: pleb < sub < vip < mod < caster *//* Never filter caster messages */if(t.issub&&(d="sub"),t.isvip&&(d="vip"),t.ismod&&(d="mod"),t.iscaster&&(d="caster"),"caster"==d)return!1;/* Includes take priority over excludes */if(a.IncludeUser.any(function(e){return e.equalsLowerCase(n)}))return!1;if(a.IncludeKeyword.any(function(e){return-1<r.indexOf(e)}))return!1;/* Role filtering */if(!a.Pleb&&"pleb"==d)return!0;if(!a.Sub&&"sub"==d)return!0;if(!a.VIP&&"vip"==d)return!0;if(!a.Mod&&"mod"==d)return!0;/* Content filtering ("Bits" also filters out cheer effects) */if(!a.Bits&&t.flags.bits)return!0;if(!a.Me&&t.flags.action)return!0;/* Exclude filtering */if(a.ExcludeUser.any(function(e){return e.equalsLowerCase(n)}))return!0;if(a.ExcludeStartsWith.any(function(e){return r.startsWith(e)}))return!0;/* Filtering to permitted channels (default: permit all) */if(0<a.FromChannel.length){var l=!0,o=!1,c=void 0;try{for(var u,g,p=a.FromChannel[Symbol.iterator]();!(l=(u=p.next()).done);l=!0)if(g=u.value,t.channelString.equalsLowerCase(g))return!1}catch(e){o=!0,c=e}finally{try{!l&&p.return&&p.return()}finally{if(o)throw c}}return!0}}else if(t instanceof TwitchEvent&&!a.Event&&("USERNOTICE"===t.command||"NOTICE"===t.command))/* Event filtering: notices and user notices */return!0;if(window.Plugins&&!window.PluginsAreDisabled){var y=Plugins.invoke("shouldFilter",e,t);if(y&&0<y.length){var h=!0,f=!1,m=void 0;try{for(var b,v,S=y[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)if(v=b.value,!0===v||!1===v)return v;/* Other values: continue the filtering logic */}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}}}return!1}/* Populate and show the username context window */function showUserContextWindow(e,a,n){var i=Math.round,o=Number.parseInt;/* Define functions for building elements */function r(e){var t=$("<div class=\"item\"></div>");return"string"==typeof e?t.html(e):t.append(e),t}function d(e,t){var a=$("<a class=\"cw-link\"></a>");return a.attr("id",e),a.text(t),a}var s=$(a),c=$(n),u=c.attr("data-id"),g=c.attr("data-user"),p=c.find(".username").text(),f=c.attr("data-user-id"),m="#"+c.attr("data-channel"),b=c.attr("data-channelid"),v="1"===c.attr("data-subscriber"),S="1"===c.attr("data-mod"),y="1"===c.attr("data-vip"),x="1"===c.attr("data-caster"),C=o(c.attr("data-sent-ts")),k=new Date(C);/* Attributes of the host line */s.html(""),s.attr("data-id",u),s.attr("data-user",g),s.attr("data-user-id",f),s.attr("data-channel",m),s.attr("data-chid",b),s.attr("data-sub",v),s.attr("data-mod",S),s.attr("data-vip",y),s.attr("data-caster",x),s.attr("data-id",u);var L=function(e){return $("<span class=\"em pad\"></span>").html(e)},T=c.find(".username"),E=T.attr("class").escape(),H=T.attr("style").escape();/* Add user's display name *//* Add link to timeout user */if(s.append(r("<span class=\""+E+"\" style=\""+H+"\">"+p+"</span>"+" in <span class=\"em\">"+m+"</span>")),e.IsMod(m)){var I=$("<div class=\"cw-timeout\">Timeout:</div>"),P=!0,M=!1,N=void 0;try{for(var A,D=["1s","10s","60s","10m","30m","1h","12h","24h"][Symbol.iterator]();!(P=(A=D.next()).done);P=!0){var F=A.value,_=d("cw-timeout-"+g+"-"+F,F);_.addClass("cw-timeout-dur"),_.attr("data-channel",m),_.attr("data-user",g),_.attr("data-duration",F),_.click(function(){var t=$(this).attr("data-channel"),n=$(this).attr("data-user"),r=$(this).attr("data-duration");e.Timeout(t,n,r),Util.Log("Timed out user "+n+" from "+t+" for "+r),$(a).fadeOut()}),I.append(_)}}catch(e){M=!0,N=e}finally{try{!P&&D.return&&D.return()}finally{if(M)throw N}}s.append(I)}/* Add link which places "/ban <user>" into the chat textbox */if(e.IsMod(m)){var X=d("cw-ban-"+g,"Ban");X.addClass("cw-ban-user"),X.attr("data-channel",m),X.attr("data-user",g),X.click(function(){$("#txtChat").val("/ban "+$(this).attr("data-user"))}),s.append(X)}/* Add other information */var O=Util.FormatDate(k),G=Util.FormatInterval((Date.now()-C)/1e3);/* Add roles (and ability to remove roles, for the caster) */if(s.append(r("Sent: "+O+" ("+G+" ago)")),s.append(r("UserID: "+f)),s.append(r("MsgUID: "+u)),S||y||v||x){var U=r("User Role: "),R=[];if(S&&R.push(L("Mod")),y&&R.push(L("VIP")),v&&R.push(L("Sub")),x&&R.push(L("Host")),0<R.length){U.append(R[0]);var W=!0,j=!1,V=void 0;try{for(var B,z,K=R.slice(1)[Symbol.iterator]();!(W=(B=K.next()).done);W=!0)z=B.value,U.append(", "),U.append(z)}catch(e){j=!0,V=e}finally{try{!W&&K.return&&K.return()}finally{if(j)throw V}}s.append(U)}e.IsCaster(m)&&!e.IsUIDSelf(f)&&(S&&s.append(r(d("cw-unmod","Remove Mod"))),y&&s.append(r(d("cw-unvip","Remove VIP"))))}/* Add the ability to add roles (for the caster) */e.IsCaster(m)&&!e.IsUIDSelf(f)&&(!S&&s.append(r(d("cw-make-mod","Make Mod"))),!y&&s.append(r(d("cw-make-vip","Make VIP")))),Util.Trace("Showing ucw for",c);var J=c.offset(),Q=i(J.top)+c.outerHeight()+2,t=i(J.left),l=s.outerWidth(),w=s.outerHeight(),h={top:Q,left:t,width:l,height:w};Util.ClampToScreen(h),delete h.width,delete h.height,s.fadeIn().offset(h)}/* Set or unset transparency */function updateTransparency(e){/* exported updateTransparency */var t=[];try{var a=Util.CSS.GetSheet("main.css"),n=Util.CSS.GetRule(a,":root"),r=!0,d=!1,i=void 0;/* Find the prop="--<name>-color" rules */try{for(var l,o,s=Util.CSS.GetPropertyNames(n)[Symbol.iterator]();!(r=(l=s.next()).done);r=!0)o=l.value,o.match(/^--[a-z-]+-color$/)&&t.push(o)}catch(e){d=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(d)throw i}}}catch(a){/* Unable to enumerate properties; use hard-coded ones */Util.ErrorOnce("Failed getting main.css :root",a),t=["--body-color","--header-color","--menudiv-color","--module-color","--odd-line-color","--sub-color","--chat-color","--textarea-color"]}var c=!0,u=!1,g=void 0;try{for(var p,h,f=t[Symbol.iterator]();!(c=(p=f.next()).done);c=!0)h=p.value,e?(Util.CSS.SetProperty(h,"transparent"),$(".module").addClass("transparent"),$("body").addClass("transparent")):(Util.CSS.SetProperty(h,"var("+h+"-default)"),$(".module").removeClass("transparent"),$("body").removeClass("transparent"))}catch(e){u=!0,g=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw g}}}/* Set the colorscheme to dark */function setDarkScheme(){/* exported setDarkScheme */$("body").removeClass("light").addClass("dark"),$("#btnSettings").attr("src",AssetPaths.SETTINGS)}/* Set the colorscheme to light */function setLightScheme(){/* exported setLightScheme */$("body").removeClass("dark").addClass("light"),$("#btnSettings").attr("src",AssetPaths.SETTINGS_LIGHT)}/* Set or clear window notification badge */function setNotify(){var e=!(0<arguments.length&&arguments[0]!==void 0)||arguments[0],t=e?AssetPaths.FAVICON_ALERT:AssetPaths.FAVICON;/* exported setNotify */$("link[rel=\"shortcut icon\"]").attr("href",t)}/* Called once when the document loads */function doLoadClient(){var u=Number.parseInt,g=Math.clamp;/* Function for syncing configuration with HTMLGen */function e(){var e=!0,t=!1,a=void 0;try{for(var n,r=Object.entries(getConfigObject())[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var d=n.value,i=_slicedToArray(d,2),l=i[0],o=i[1];p.get("HTMLGen").setValue(l,o)}}catch(e){t=!0,a=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw a}}}/* Add highlight patterns *//* Close the main settings window */function t(){updateModuleConfig(),$("#advSettings").slideUp(),$("#settings").fadeOut()}/* Open the main settings window */function a(){var e=getConfigObject(!0);$("#txtChannel").val(e.Channels.join(",")),$("#txtNick").val(e.Name||Strings.NAME_AUTOGEN),e.Pass&&0<e.Pass.length&&($("#txtPass").attr("disabled","disabled").hide(),$("#txtPassDummy").show()),$("#selDebug").val(""+e.Debug),$("#settings").fadeIn()}/* Toggle the main settings window */function n(){$("#settings").is(":visible")?t():a()}/* Close a module's settings window */function r(e){updateModuleConfig();var t=$(e).find(".settings"),a=t.siblings("input.name"),n=t.siblings("label.name");a.hide(),n.html(a.val()).show(),t.fadeOut()}/* Open a module's settings window */function d(e){var t=$(e).find(".settings"),a=t.siblings("input.name"),n=t.siblings("label.name");n.hide(),a.val(n.html()).show(),t.fadeIn()}/* Toggle a module's settings window */function i(e){var t=$(e).find(".settings");t.is(":visible")?r(e):d(e)}/* Reset chat auto-completion variables */function o(){var e=$("#txtChat");e.attr("data-complete-text",""),e.attr("data-complete-pos","-1"),e.attr("data-complete-index","0")}/* Reset chat history recall */function s(){$("#txtChat").attr("data-hist-index","-1")}/* Open the settings builder page */function c(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})}/* Purge message(s) from chat *//* exported doLoadClient *//* Initialize chat auto-completion and history */var p=null,h={};Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_DEBUG){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];Content.addErrorText("ERROR: "+(e=Util.Logger).stringify.apply(e,a))}},"ERROR"),Util.Logger.addHook(function(){for(var e=arguments.length,t=Array(2<e?e-2:0),a=2;a<e;a++)t[a-2]=arguments[a];if(1===t.length&&t[0]instanceof TwitchEvent)Util.DebugLevel>=Util.LEVEL_TRACE&&Content.addNoticeText("WARNING: "+JSON.stringify(t[0]));else if(Util.DebugLevel>=Util.LEVEL_DEBUG){var n;Content.addNoticeText("WARNING: "+(n=Util.Logger).stringify.apply(n,t))}},"WARN"),Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];Content.add("DEBUG: "+(e=Util.Logger).stringify.apply(e,a))}},"DEBUG"),Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];Content.add("TRACE: "+(e=Util.Logger).stringify.apply(e,a))}},"TRACE"),Util.DebugLevel<Util.LEVEL_TRACE&&(Util.Logger.addFilter(/ws (send|recv)>.+(PING|PONG) :tmi.twitch.tv/),Util.Logger.addFilter(/tmi.twitch.tv (JOIN|PART) #/)),$("#txtNick").val(""),$("#txtPass").val(""),ChatCommands.add("config",function(e,a){var n=Number.parseFloat,r=getConfigObject(!0),d=0<a.length?a[0]:"";if(0===a.length){var X=[];Content.addHelp("<em>Global Configuration Values:</em>");var i=!0,l=!1,o=void 0;try{for(var s,c=Object.entries(r)[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var g=s.value,p=_slicedToArray(g,2),f=p[0],m=p[1],b=f,v="object"===("undefined"==typeof m?"undefined":_typeof(m))?JSON.stringify(m):""+m;"Layout"===f?v=FormatLayout(m):"ClientID"===f?v="Omitted for security; use //config clientid to show":"Pass"===f?v="Omitted for security; use //config pass to show":"object"===("undefined"==typeof m?"undefined":_typeof(m))&&m.Name&&0<m.Name.length&&(b=v=null,X.push([f,m])),null!==b&&Content.addHelpLine(""+b,""+v,!0)}}catch(e){l=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(l)throw o}}Content.addHelp("<em>Window Configuration Values:</em>");var S=!0,y=!1,x=void 0;try{for(var C,k=X[Symbol.iterator]();!(S=(C=k.next()).done);S=!0){var L=C.value,T=_slicedToArray(L,2),E=T[0],w=T[1];Content.addHelpText("Module "+E+": "+w.Name);var H=!0,I=!1,P=void 0;try{for(var M,N=Object.entries(w)[Symbol.iterator]();!(H=(M=N.next()).done);H=!0){var A=M.value,D=_slicedToArray(A,2),F=D[0],_=D[1];"Name"!==F&&Content.addHelpLine(""+F,""+_,!0)}}catch(e){I=!0,P=e}finally{try{!H&&N.return&&N.return()}finally{if(I)throw P}}}}catch(e){y=!0,x=e}finally{try{!S&&k.return&&k.return()}finally{if(y)throw x}}}else if("help"===d)Content.addHelpLine("//config","Show and manipulate configuration"),Content.addHelpText("//config parameters:"),Content.addHelpLine("export","Export *all* of localStorage to a new tab (contains passwords!)"),Content.addHelpLine("purge","Clear localStorage (cannot be undone!)"),Content.addHelpLine("clientid","Display ClientID"),Content.addHelpLine("pass","Dislay OAuth token (if one is present)"),Content.addHelpLine("url","Generate a URL from the current configuration"),Content.addHelpText("//config url parameters (can be used in any order):"),Content.addHelpLine("git","Force URL to target github.io"),Content.addHelpLine("text","Force URL to be un-encoded"),Content.addHelpLine("auth","Include passwords in URL"),Content.addHelpLine("tag=<value>","Set the tag to <value>",!0),Content.addHelpLine("key=<value>","Use config key to <value>",!0),Content.addHelpText("//config set <key> <value>: Directly change <key> to <value> (dangerous!)"),Content.addHelpText("//config setobj <key> <value>: Directly change <key> to JSON-encoded <value> (dangerous!)"),Content.addHelpText("//config unset <key>: Remove <key> (dangerous!)");else if("export"===d)Util.Open(AssetPaths.CONFIG_EXPORT_WINDOW,"_blank",{});else if("purge"===d)Util.SetWebStorage({}),window.liveStorage={},Content.addNoticeText("Purged storage \""+Util.GetWebStorageKey()+"\"");else if("clientid"===d)Content.addHelpLine("ClientID",r.ClientID,!0);else if("pass"===d)Content.addHelpLine("Pass",r.Pass,!0);else if("url"===d){/* Generate a URL with the current configuration, omitting items
       * left at default values */var O={git:0,auth:0,base64:1,tag:h.tag||""},G=!0,U=!1,R=void 0;try{for(var W,j,V=a[Symbol.iterator]();!(G=(W=V.next()).done);G=!0)j=W.value,"git"===j&&(O.git=1),"auth"===j&&(O.auth=1),"text"===j&&(O.base64=0),j.startsWith("tag=")&&(O.tag=j.substr(4)),j.startsWith("key=")&&(O.key=j.substr(4))}catch(e){U=!0,R=e}finally{try{!G&&V.return&&V.return()}finally{if(U)throw R}}var q=genConfigURL(r,O);Content.addHelp($("<a></a>").attr("href",q).text(q))}else if(("set"===d||"setobj"===d)&&2<a.length){/* Allow changing configuration by command (dangerous) */var B=a[1],z=a.slice(2).join(" "),K=null;K="setobj"===d?JSON.parse(z):"true"===z||"false"!==z&&("Infinity"===z?1/0:"-Infinity"===z?-Infinity:"NaN"===z?NaN:z.match(/^[+-]?(?:\d|[1-9]\d*)$/)?u(z):z.match(/^[-+]?(?:\d*\.\d+|\d+)$/)?n(z):z);var Z=JSON.stringify(K);if(Util.ObjectHas(r,B)){var J=Util.ObjectGet(r,B),Q=JSON.stringify(J);Content.addHelpText("Changing "+B+" from \""+Q+"\" to \""+Z+"\""),Content.addHelpLine(B,Q,!0),Content.addHelpLine(B,Z,!0),Util.ObjectSet(r,B,K),mergeConfigObject(r)}else Content.addHelpText("Adding key "+B+" with value \""+Z+"\""),Content.addHelpLine(B,Z,!0),Util.ObjectSet(r,B,K),mergeConfigObject(r)}else if("unset"===d&&1<a.length){var Y=a[1];Util.ObjectRemove(r,Y)?(Content.addHelpText("Removed key "+Y+" from localStorage"),Util.SetWebStorage(r)):Content.addHelpText("Failed to remove key "+Y+" from localStorage"),window.liveStorage&&(Util.ObjectRemove(window.liveStorage,Y)?Content.addHelpText("Removed key "+Y+" from liveStorage"):Content.addHelpText("Failed to removed key "+Y+" from liveStorage"))}else if(Util.ObjectHas(r,d))Content.addHelpText("Configuration:"),Content.addHelpLine(d,JSON.stringify(Util.ObjectGet(r,d)),!0);else{Content.addErrorText("Unknown config command or key "+("\""+d+"\""),!0)}},"Obtain and modify configuration information; use //config help for details"),function(){var e=getConfigObject(!0);/* Change the document title to show our authentication state */if(p=new TwitchClient(e),Util.DebugLevel=e.Debug,e.Pass&&0<e.Pass.length)document.title+=" - Authenticated";else/* Change the chat placeholder and border to reflect read-only */if(document.title+=" - Read-Only",e.Layout.Chat){var t=Strings.ANON_PLACEHOLDER+": "+Strings.AUTH_PLACEHOLDER;$("#txtChat").attr("placeholder",t),Util.CSS.SetProperty("--chat-border","#cd143c")}/* Set values we'll want to use later */h=getConfigObject(),h.Plugins=!!e.Plugins,h.Pass=h.ClientID=null,delete h.Pass,delete h.ClientID}(),$(".module").each(function(){setModuleSettings(this,h[$(this).attr("id")])});/* Disable configured events */var f=!0,m=!1,b=void 0;try{for(var v,S,y=(h.EnableEffects||[])[Symbol.iterator]();!(f=(v=y.next()).done);f=!0)S=v.value,CSSCheerStyles[S]&&(CSSCheerStyles[S]._disabled=!0);/* Enable configured effects */}catch(e){m=!0,b=e}finally{try{!f&&y.return&&y.return()}finally{if(m)throw b}}var x=!0,C=!1,k=void 0;try{for(var L,T,E=(h.EnableEffects||[])[Symbol.iterator]();!(x=(L=E.next()).done);x=!0)T=L.value,CSSCheerStyles[T]&&(CSSCheerStyles[T]._disabled=!1);/* Simulate clicking cbTransparent if config.Transparent is set */}catch(e){C=!0,k=e}finally{try{!x&&E.return&&E.return()}finally{if(C)throw k}}if(h.Transparent?(updateTransparency(!0),$("#cbTransparent").check()):$("#cbTransparent").uncheck(),h.Size&&Util.CSS.SetProperty("--body-font-size",h.Size),h.Font&&Util.CSS.SetProperty("--body-font",h.Font),h.Scroll?($(".module .content").css("overflow-y","scroll"),$("#cbScroll").check()):$("#cbScroll").uncheck(),0===h.Channels.length&&$("#settings").fadeIn(),$("#cbClips").check(h.ShowClips),$("#cbForce").check(h.EnableForce),"dark"===h.ColorScheme?setDarkScheme():"light"===h.ColorScheme&&setLightScheme(),$("#cbAnimCheers").uncheck(h.NoAnim),$("#txtBGStyle").val(""),$("#txtFont").val(h.Font||Util.CSS.GetProperty("--body-font")),$("#txtFontSize").val(h.Size||Util.CSS.GetProperty("--body-font-size")),h.tag&&$("#txtTag").val(h.tag),$("#cbFanfare").check(h.Fanfare&&h.Fanfare.enable),p.set("HTMLGen",new HTMLGenerator(p,h)),p.set("Fanfare",new Fanfare(p,h)),h.Highlight){var w=!0,H=!1,I=void 0;try{for(var P,M,N=h.Highlight[Symbol.iterator]();!(w=(P=N.next()).done);w=!0)M=P.value,p.get("HTMLGen").addHighlightMatch(M)}catch(e){H=!0,I=e}finally{try{!w&&N.return&&N.return()}finally{if(H)throw I}}}/* Construct the plugins */h.Plugins?Plugins.loadAll(p,h):Plugins.disable(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(window.client=p),ChatCommands.addHelpText("Moderator commands:",{literal:!0}),ChatCommands.addHelpText("!tfc reload: Reload the page",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc force-reload: Reload the page, discarding cache",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc nuke: Completely clear the chat",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc nuke <user>: Clear messages sent by <user>",{args:!0,command:!0}),ChatCommands.addHelpText("!tfc ffdemo: Demonstrate fanfares",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc ffcheerdemo: Demonstrate default cheer fanfare",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc ffsubdemo: Demonstrate default sub fanfare",{literal:!0,command:!0}),o(),s(),ChatCommands.add("builder",function(){c()},"Open the configuration builder wizard"),$("#txtChat").keydown(function(a){var e=Number.isNaN,n=event.target,t=$(n);if(a.shiftKey)o(),s();else{if("Enter"===a.key){/* Send a message */var r=n.value,u=-1<r.indexOf(" ")?r.split(" ")[0]:"";return 0<r.trim().length&&(ChatCommands.isCommandStr(r)?ChatCommands.execute(r,p):p.channels.any(function(e){return u.equalsLowerCase(e)})?p.SendMessage(u,r.substr(u.length).strip()):p.SendMessageToAll(r),p.AddHistory(r),n.value="",o(),s()),a.preventDefault(),!1}if("Process"===a.key&&"Tab"===a.code);else{if("Tab"===a.key){/* Tab completion */var c=t.attr("data-complete-text")||n.value,h=Util.ParseNumber(t.attr("data-complete-pos")),f=Util.ParseNumber(t.attr("data-complete-index"));(e(h)||-1===h)&&(h=n.selectionStart),e(f)&&(f=0);var b={oText:c,oPos:h,cText:n.value,cPos:n.selectionStart,index:f};return b=ChatCommands.complete(p,b),t.attr("data-complete-text",b.oText),t.attr("data-complete-pos",b.oPos),t.attr("data-complete-index",b.index),n.value=b.cText,requestAnimationFrame(function(){n.selectionStart=b.cPos,n.selectionEnd=b.cPos}),s(),a.preventDefault(),!1}if("ArrowUp"===a.key||"ArrowDown"===a.key){/* Handle traversing message history */var m=p.GetHistoryLength(),l={ArrowUp:1,ArrowDown:-1}[a.key],d=l+Util.ParseNumber(t.attr("data-hist-index")),i=p.GetHistoryItem(g(d,-1,m-1));/* Restrict i to [-1, length-1] */null!==i&&(n.value=i.trim()),t.attr("data-hist-index",""+d),requestAnimationFrame(function(){n.selectionStart=n.value.length,n.selectionEnd=n.value.length}),o()}else o(),s()}}}),$("#settings").keyup(function(t){"Enter"===t.key&&n()}),$("#btnSettings").click(function(){n()}),$("#btnSettingsHelp").click(function(){Util.Open(AssetPaths.HELP_WINDOW,"_blank",{})}),$("#btnSettingsBuilder").click(function(){c()}),onChange($("#txtChannel"),function(){setChannels(p,$(this).val().split(",")),mergeConfigObject({Channels:p.GetJoinedChannels()})}),$("#cbScroll").change(function(){var e=$(this).is(":checked");mergeConfigObject({Scroll:e}),$(".module .content").css("overflow-y",e?"scroll":"hidden")}),$("#cbTransparent").change(function(){updateTransparency($(this).is(":checked")),e()}),$("#cbClips").change(function(){mergeConfigObject({ShowClips:$(this).is(":checked")}),e()}),$("#cbFanfare").change(function(){p.get("Fanfare").enable=$(this).is(":checked")}),$("#cbForce").change(function(){mergeConfigObject({EnableForce:$(this).is(":checked")}),e()}),$("#selDebug").change(function(){var e=Util.ParseNumber($(this).val());Util.Log("Changing debug level from "+Util.DebugLevel+" to "+e),Util.DebugLevel=e}),$("#btnReconnect").click(function(){p.Connect()}),$("#btnAdvanced, #btnAdvHide").click(function(){$("#advSettings").slideToggle()}),$("#cbAnimCheers").change(function(){mergeConfigObject({NoAnim:!$(this).is(":checked")}),e()}),onChange($("#txtBGStyle"),function(){$(".module").css("background-image",$(this).val())}),onChange($("#txtFont"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font","var(--body-font-default)"):Util.CSS.SetProperty("--body-font",e))}),onChange($("#txtFontSize"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font-size","var(--body-font-size-default)"):Util.CSS.SetProperty("--body-font-size",e))}),onChange($("#txtTag"),function(){mergeConfigObject({tag:$(this).val()})}),$(".module .header input.name").keyup(function(t){var e=$(this).parentsUntil(".column").last();"Enter"===t.key?r(e):"Escape"===t.key&&(e.find("input.name").val(e.find("label.name").html()),r(e))}),$(".module .header .clear-link").click(function(){$(this).parentsUntil(".column").find(".line-wrapper").remove()}),$(".module .settings input[type=\"text\"]").keyup(function(t){if("Enter"===t.key){/* Enter: add a new entry */var l=$(this).val();if(0<l.length){var e=$(this).closest("li"),a=e.attr("class").replace("textbox","").trim(),n=p.get("HTMLGen").checkbox(l,null,a,!0),d=e.find("label").html(),i=$("<li><label>"+n+d+" "+l+"</label></li>");e.before(i),$(this).val(""),updateModuleConfig()}}else"Escape"===t.key&&/* Escape: close settings */r($(this).parentsUntil(".column").last())}),$(document).keyup(function(t){if("ScrollLock"===t.key){/* ScrollLock: pause or resume auto-scroll */var e=$(".module .content"),a=e.attr("data-no-scroll");a?(e.removeAttr("data-no-scroll"),Util.Log("Auto-scroll enabled"),Content.addHelpText("Auto-scroll enabled")):(e.attr("data-no-scroll","1"),Util.Log("Auto-scroll disabled"),Content.addHelpText("Auto-scroll disabled"))}else if("Escape"===t.key){$("#settings").is(":visible")&&$("#settings").fadeOut();var n=!0,d=!1,i=void 0;try{for(var l,o,s=Object.values(getModules())[Symbol.iterator]();!(n=(l=s.next()).done);n=!0)o=l.value,$(o).find(".settings").is(":visible")&&r($(o))}catch(e){d=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(d)throw i}}}else"F1"===t.key&&/* F1: open configuration help window */c()}),$(document).click(function(a){var e=$(a.target),n=a.clientX,d=a.clientY,l=!0,o=!1,s=void 0;/* Clicking on or off of the module settings button or box */try{for(var c,u=Object.values(getModules())[Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var g=c.value,h=$(g),f=h.find(".menu"),m=h.find(".header"),b=h.find(".settings");Util.PointIsOn(n,d,f)?i(h):b.is(":visible")&&!Util.PointIsOn(n,d,b)&&!Util.PointIsOn(n,d,m)&&r(h)}/* Clicking off the main settings window */}catch(e){o=!0,s=e}finally{try{!l&&u.return&&u.return()}finally{if(o)throw s}}var v=$("#settings");if(v.is(":visible")){var k=!0;0<v.has(a.target||a.currentTarget).length?k=!1:Util.PointIsOn(n,d,v)&&(k=!1),k&&t()}/* Clicking on the username context window */var S=$("#userContext");if(Util.PointIsOn(n,d,S)){var y=S.attr("data-channel"),x=S.attr("data-user"),C=S.attr("data-user-id");p.IsUIDSelf(C)||("cw-unmod"===e.attr("id")?(Util.Log("Unmodding "+x+" in "+y),p.SendMessage(y,"/unmod "+x)):"cw-unvip"===e.attr("id")?(Util.Log("Removing VIP for "+x+" in "+y),p.SendMessage(y,"/unvip "+x)):"cw-make-mod"===e.attr("id")?(Util.Log("Modding "+x+" in "+y),p.SendMessage(y,"/mod "+x)):"cw-make-vip"===e.attr("id")&&(Util.Log("VIPing "+x+" in "+y),p.SendMessage(y,"/vip "+x)))}else if("1"===e.attr("data-username")){/* Clicked on a username; show context window */var L=e.parent();S.is(":visible")?S.attr("data-user-id")===L.attr("data-user-id")?S.fadeOut():showUserContextWindow(p,S,L):showUserContextWindow(p,S,L)}else S.is(":visible")&&/* Clicked somewhere else: close context window */S.fadeOut();/* Clicking on a "Reconnect" link */"1"===e.attr("data-reconnect")&&(Content.addNoticeText("Reconnecting..."),p.Connect())}),$(document).focus(function(){p.get("HTMLGen").setValue("focus",!0),setNotify(!1)}),$(document).blur(function(){p.get("HTMLGen").setValue("focus",!1)}),p.bind("twitch-open",function(){$(".loading").remove(),$("#debug").hide(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(p.IsAuthed()?Content.addInfoText("Connected (authenticated)"):Content.addInfoText("Connected (unauthenticated)")),0===getConfigValue("Channels").length&&Content.addInfoText("No channels configured; type //join <channel> to join one!")}),p.bind("twitch-close",function(t){var e=t.values.event.code,a=t.values.event.reason,n="(code "+e+" "+Util.WSStatus[e]+")";a&&(n="(code "+e+" "+Util.WSStatus[e]+": "+a+")"),getConfigValue("NoAutoReconnect")?Content.addErrorText("Connection closed "+n+" "+Strings.RECONNECT):(Content.addErrorText("Connection closed "+n+"; reconnecting in 5 seconds..."),!p.connecting&&window.setTimeout(function(){p.Connect()},5e3))}),p.bind("twitch-joined",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Joined "+Twitch.FormatChannel(t.channel))}),p.bind("twitch-parted",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Left "+Twitch.FormatChannel(t.channel))}),p.bind("twitch-notice",function(t){var e=Twitch.FormatChannel(t.channel),a=t.message;"host_on"===t.noticeMsgId||("cmds_available"===t.noticeMsgId?(Content.addNoticeText(e+": "+a),Content.addInfoText("Use //help to see Twitch Filtered Chat commands")):Content.addNoticeText(e+": "+a))}),p.bind("twitch-error",function(t){Util.Error(t);var e=t.user,a=t.values.command,n=t.message;Content.addErrorText("Error for "+e+": "+a+": "+n)}),p.bind("twitch-message",function(t){Util.DebugLevel>=Util.LEVEL_TRACE&&(t instanceof TwitchEvent?Content.addPreText(t.repr()):Content.addPreText(JSON.stringify(t)))}),p.bind("twitch-streaminfo",function(t){var e=getConfigValue("Layout"),a=p.GetChannelInfo(t.channelString)||{};if(e&&!e.Slim)if(a.online)try{/* Helix changes:
           * name = cinfo.stream.user_name
           * game = cinfo.stream.game_id (translate to game name)
           * viewers = cinfo.stream.viewer_count */var n=a.stream.channel.display_name,r=a.stream.game,d=a.stream.viewers;Content.addNotice(Strings.StreamInfo(n,r,d)),a.stream.channel.status&&Content.addNoticeText(a.stream.channel.status)}catch(e){Util.ErrorOnly("Failed to obtain stream information:",a),Util.Error(e),Content.addNotice(Strings.StreamOnline(t.channelString))}else Content.addNotice(Strings.StreamOffline(t.channelString))}),p.bind("twitch-chat",function(t){if(t instanceof TwitchChatEvent){var o="string"==typeof t.message?t.message:"";/* Handle !tfc commands */if(t.flags&&t.flags.mod&&-1<o.indexOf(" ")){var s=o.split(" ");if("!tfc"===s[0]){if("reload"===s[1])location.reload();else if("force-reload"===s[1])location.reload(!0);else if("clear"===s[1])$(".content").children().remove();else if("nuke"===s[1]){if(s[2]&&1<s[2].length){var u=CSS.escape(s[2].toLowerCase());$("[data-user=\""+u+"\"]").parent().remove()}else $(".content").children().remove();}else if("ffdemo"===s[1]){var g=p.get("Fanfare");g._onChatEvent(p,{bits:1e3},!0),g._onSubEvent(p,{kind:TwitchSubEvent.KIND_SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}else if("ffcheerdemo"===s[1]){var h=p.get("Fanfare");h._onChatEvent(p,{bits:1e3},!0)}else if("ffsubdemo"===s[1]){var f=p.get("Fanfare");f._onSubEvent(p,{kind:TwitchSubEvent.KIND_SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}return}}}$(".module").each(function(){var e=p.get("HTMLGen");if(!shouldFilter($(this),t)){/* Not filtering; format and display the event */var a=$(this).find(".content"),n=e.gen(t),r=n.find(".message[data-clip]");/* If a clip is present, display that too */if(0<r.length){var d=r.attr("data-clip");/* Nested because the second then() needs both clip and game data */p.GetClip(d).then(function(t){p.GetGame(t.game_id).then(function(n){Content.addHTML(e.genClip(d,t,n),a)})})}/* If .at-self or .highlight is given, set the notification icon */e.getValue("focus")||(0<n.find(".message.at-self").length?setNotify(!0):0<n.find(".highlight").length&&setNotify(!0)),Content.addHTML(n,a)}});/* Avoid flooding the DOM with stale chat messages */var e=getConfigValue("MaxMessages"),a=!0,n=!1,r=void 0;try{for(var d,i,l=$(".content")[Symbol.iterator]();!(a=(d=l.next()).done);a=!0)for(i=d.value;$(i).find(".line-wrapper").length>e;)$(i).find(".line-wrapper").first().remove()}catch(e){n=!0,r=e}finally{try{!a&&l.return&&l.return()}finally{if(n)throw r}}}),p.bind("twitch-clearchat",function(t){if(t.flags["target-user-id"]){/* Moderator timed out a user */var e=CSS.escape(t.flags["room-id"]),a=CSS.escape(t.flags["target-user-id"]),n=$(".chat-line[data-channel-id=\""+e+"\"][data-user-id=\""+a+"\"]");n.parent().remove()}else/* Moderator cleared the chat */$("div.content").find(".line-wrapper").remove()}),p.bind("twitch-clearmsg",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unhandled CLEARMSG:",t)}),p.bind("twitch-sub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").sub(t))}),p.bind("twitch-resub",function(t){/* Display the resub message, if one is present */if(Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").resub(t)),t.message){var e=p.get("HTMLGen").gen(t);e.addClass("message"),e.addClass("sub-message"),e.addClass("sub-user-message"),Content.addHTML(e)}}),p.bind("twitch-giftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftsub(t))}),p.bind("twitch-anongiftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").anongiftsub(t))}),p.bind("twitch-raid",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").raid(t))}),p.bind("twitch-newuser",function(t){Util.StorageAppend(LOG_KEY,t);var e=p.get("HTMLGen"),a=e.newUser(t);a.find(".message").addClass("effect-rainbow").addClass("effect-disco"),Content.addHTML(a),Content.addHTML(e.gen(t))}),p.bind("twitch-rewardgift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").rewardGift(t))}),p.bind("twitch-mysterygift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").mysteryGift(t))}),p.bind("twitch-giftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-primeupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-anongiftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-otherusernotice",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unknown USERNOTICE",t)}/* TODO: bitsbadgetier */),p.bind("twitch-hosttarget",function(t){var e=t.channelString.escape(),a=Strings.Streamer(t.user),n=$("<span class=\"host-message\"></span>"),r=$("<span class=\"btn url\">Click here to join!</span>");/* A user of "-" refers to an "unhost" */"-"!==t.user&&(n.html(e+" is hosting #"+a+": "),n.click(function(){p.LeaveChannel(e),p.JoinChannel(t.user)}),n.append(r),Content.addNotice(n))}),p.bind("twitch-reconnect",function(){}),p.bind("twitch-join",function(){}),p.bind("twitch-part",function(){}),p.bind("twitch-userstate",function(){}),p.bind("twitch-roomstate",function(){}),p.bind("twitch-globaluserstate",function(){}),p.bind("twitch-usernotice",function(){}),p.bind("twitch-ack",function(){}),p.bind("twitch-ping",function(){}),p.bind("twitch-names",function(){}),p.bind("twitch-topic",function(){}),p.bind("twitch-privmsg",function(){}),p.bind("twitch-whisper",function(){}),p.bind("twitch-mode",function(){}),p.bind("twitch-other",function(){}),p.bindDefault(function(t){Util.Warn("Unbound event:",t),Util.StorageAppend(LOG_KEY,t)}),p.Connect()}/* globals AssetPaths Strings CSSCheerStyles GIT_URL CUR_URL LOG_KEY CFG_KEY *//* globals HTMLGenerator GetLayout ParseLayout FormatLayout Fanfare *//* vim: set ts=2 sts=2 sw=2 et: */